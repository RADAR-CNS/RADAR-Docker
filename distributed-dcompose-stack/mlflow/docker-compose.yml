version: '3.3'

services:
    waitfordb:
      image: dadarek/wait-for-dependencies
      depends_on:
        - pgdb
      command: pgdb:5432
      networks:
            - backend

    pgdb:
        image: postgres:13.1-alpine
        ports:
          - 5432:5432
        environment:
          POSTGRES_USER: ${POSTGRES_USER}
          POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
          POSTGRES_DB: mlflow-db
        restart: always
        volumes:
          - ${MP_POSTGRES_DIR}/data:/var/lib/postgresql/data/
        networks:
            - backend

    mlflow-server:
        restart: always
        build:
          context: ../../images/mlflow-server/
          args:
            - DB_URI=postgresql+psycopg2://${POSTGRES_USER}:${POSTGRES_PASSWORD}@pgdb:5432/mlflow-db
            - SERVER_HOST=${HOST}
            - SERVER_PORT=${MLFLOW_PORT}
            - MLFLOW_HOME=${MLFLOW_HOME}
            - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
            - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
            - AWS_DEFAULT_REGION=${AWS_REGION}
            - MLFLOW_S3_ENDPOINT_URL=http://s3:9000
            - AWS_BUCKET_NAME=${AWS_BUCKET_NAME}
        ports:
            - ${MLFLOW_PORT}:${MLFLOW_PORT}
        expose:
            - 5000
        networks:
            - backend
        depends_on:
            - pgdb
            - waitfordb
            - s3

    s3:
        image: minio/minio:latest
        container_name: aws-s3
        ports:
          - 9000:9000
        environment:
          - MINIO_ACCESS_KEY=${AWS_ACCESS_KEY_ID}
          - MINIO_SECRET_KEY=${AWS_SECRET_ACCESS_KEY}
          - MLFLOW_S3_ENDPOINT_URL=${MLFLOW_S3_ENDPOINT_URL}
          - AWS_BUCKET_NAME=${AWS_BUCKET_NAME}
        command: server /date
        networks:
          - backend
        volumes:
          - ${MP_POSTGRES_DIR}/s3:/date

networks:
    backend:
        driver: bridge

volumes:
    postgresql: