#!/bin/bash

cd "$(dirname "${BASH_SOURCE[0]}")/.."

. ./.env

echo "Are you sure you want to initialize HDFS High Availability?"

select yn in "Yes" "No"; do
  case $yn in
    Yes ) break;;
    No ) exit;;
  esac
done

echo "==> Setting up name node 1"
bin/radar-docker up -d --remove-orphans zookeeper-1 zookeeper-2 zookeeper-3 hdfs-journalnode-1 hdfs-journalnode-2 hdfs-journalnode-3
bin/radar-docker quit hdfs-namenode-1 hdfs-namenode-2
bin/radar-docker run --name hdfs-namenode-1 --rm hdfs-namenode-1 sh -c "su-exec hdfs hdfs namenode -initializeSharedEdits && su-exec hdfs hdfs zkfc -formatZK -force"
bin/radar-docker up -d hdfs-namenode-1
printf "==> Waiting for name node 1 to come online"
while ! bin/radar-docker exec hdfs-namenode-1 hdfs dfs -test -e hdfs://hdfs-namenode-1/ 2>/dev/null >/dev/null; do
  sleep 1
  printf '.'
done
sleep 5
echo
echo "==> Setting up name node 2"
bin/radar-docker run --rm --name hdfs-namenode-2 hdfs-namenode-2 namenode-2 -bootstrapStandby -force

echo "==> Bringing up HDFS cluster"
bin/radar-docker hdfs
